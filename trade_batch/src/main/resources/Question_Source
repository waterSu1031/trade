@Slf4j
@Component
@ConfigurationProperties(prefix = "ibkr.api")
public class ClientIBKR implements EWrapper {

    private final EClientSocket client;
    private final EJavaSignal signal;
    private final AtomicBoolean connected = new AtomicBoolean(false);
    private int reconnectAttempts = 0;

    @Value("${ibkr.api.host}") private String host;
    @Value("${ibkr.api.port}") private int port;
    @Value("${ibkr.api.clientId}") private int clientId;


    @Autowired
    public ClientIBKR() {
        this.signal = new EJavaSignal();
        this.client = new EClientSocket(this, signal);
    }

    public void connect() {
        if (!connected.get()) {
            client.eConnect(host, port, clientId);
            if (client.isConnected()) {
                connected.set(true);

                EReader reader = new EReader(client, signal);
                reader.start();
                new Thread(() -> {
                    while (client.isConnected()) {
                        signal.waitForSignal();
                        try {
                            reader.processMsgs();
                        } catch (Exception e) {
                            log.error("EReader processing error", e);
                        }
                    }
                }, "ibkr-reader").start();
                reconnectAttempts = 0;
                log.info("IBKR 연결 성공: {}:{} (clientId={})", host, port, clientId);
            } else {
                throw new RuntimeException("IBKR 연결 실패");
            }
        }
    }

    public void disconnect() {
        if (client.isConnected()) {
            client.eDisconnect();
            connected.set(false);
            log.info("IBKR 연결 해제");
        }
    }

    @Override
    public void connectionClosed() {
        log.warn("IBKR 연결 종료됨! 5초 후 재연결 시도");
        if(reconnectAttempts < 3) {
            try {
                Thread.sleep(5000);
            } catch (InterruptedException ignored) {}
            connect(); // 별도 재연결 메소드 구현
            reconnectAttempts++;
            log.info("IBKR 서버 재연결 시도");
        }else {
            log.error("IBKR 재연결 3회 실패! 더 이상 시도하지 않습니다.");
            // 필요하면 알림/이벤트 추가
        }
    }
}